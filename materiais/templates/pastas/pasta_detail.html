{% extends 'base.html' %}

{% load static %}

{% block title %}Detalhes da Trilha{% endblock %}

{% block content %}

    <!-- Course Details -->
    <section class="section">
        <div class="container">
            <div class="course-details">
                <div class="course-details-header">
                    <div class="course-details-info">
                        <h1 class="course-details-title">{{ pasta.nome }}</h1>
                        <div class="course-details-meta">
                            <span class="meta-item"><strong>Criada por:</strong> {{ pasta.created_by.first_name }} {{ pasta.created_by.last_name }}</span>
                            <span class="meta-item"><strong>Carga Horaria:</strong> {{ pasta.carga_horaria|default:"Nao informada" }} horas</span>
                            <span class="meta-item"><strong>Setores:</strong> {% if pasta.setores.all %}{{ pasta.setores.all|join:", " }}{% else %}Todos{% endif %}</span>
                            <!-- Verificar se possui prova disponível ou não -->
                            <span class="badge">Clique aqui para realizar a prova</span>
                            <!-- Verificar se possui pesquisa de satisfação para fazer ou não -->
                            <span class="badge">Clique aqui para responder a pesquisa</span>
                        </div>
                    </div>
                </div>

                <div class="course-details-content">
                    <div class="course-description">
                        <h2 class="section-subtitle">Sobre a Trilha</h2>
                        <p>{{ pasta.descricao|default:"Nenhuma descricao disponivel para esta trilha." }}</p>
                    </div>

                    <div class="course-curriculum">
                        <h2 class="section-subtitle">Arquivos anexados</h2>
                        
                        <div class="accordion">
                            {% for material in materiais %}
                            <div class="accordion-item">
                                <button class="accordion-header">
                                    <span>{{ material.nome }}</span>
                                    <span class="accordion-icon">+</span>
                                </button>
                                <div class="accordion-content">
                                    <ul class="lesson-list">
                                        <li><a class="btn btn-sm btn-primary" href="{% url 'detail-material' material.id %}">Acessar</a></li>
                                    </ul>
                                </div>
                            </div>
                            {% empty %}
                            <p>O criador da trilha ainda não adicionou material.</p>
                            {% endfor %}
                        </div>

                        <h2 class="section-subtitle mt-4">Arquivos do Drive</h2>
                        <section class="section section-gray">
                            <div class="container">
                                <div class="courses-grid" id="drive-files">
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block scripts %}

<script src="{% static 'js/drive/carregar_arquivos_drive.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('drive-files');
    const placeholder = document.getElementById('drive-placeholder');
    if (!container) return;

    fetch("{% url 'pastas-detail-drive' pasta.pk %}")
        .then(response => response.json())
        .then(data => {
            if (placeholder) placeholder.remove();
            if (!data.success || !data.arquivos || !data.arquivos.length) {
                container.innerHTML = '<div class="col-12 text-muted">Nenhum arquivo do Drive disponivel.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            data.arquivos.forEach(file => {
                const col = document.createElement('div');
                col.innerHTML = `
                    <div class="course-card drive-card">
                        <div class="course-content">
                            <h3 class="course-title">${file.nome || 'Arquivo sem nome'}</h3>
                            <p class="course-instructor">${file.tipo || 'Tipo desconhecido'}</p>
                            <div class="course-meta">
                                <span class="course-duration">${file.tamanho || ''}</span>
                                <span class="course-level">${file.extensao || ''}</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success btn-sm" onclick="visualizarArquivoDrive('${file.id}', '${file.tipo}', '${file.nome || 'Arquivo'}')" title="Visualizar">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <a class="btn btn-sm btn-primary" href="${file.link_download}" target="_blank" rel="noopener">Download</a>
                            </div>
                        </div>
                    </div>
                `;
                fragment.appendChild(col);
            });
            container.appendChild(fragment);
        })
        .catch(() => {
            if (placeholder) placeholder.remove();
            container.innerHTML = '<div class="col-12 text-danger">Erro ao carregar arquivos do Drive.</div>';
        });
});
</script>
{% endblock %}
